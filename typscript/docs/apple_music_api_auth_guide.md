# Apple Music API Authentication Guide for MCP Server

## Overview

The Apple Music API requires two distinct authentication mechanisms to access different types of data. The MCP server must implement support for both authentication types to provide complete functionality for accessing both public catalog data and user-specific library information.

## Authentication Types

### 1. Developer Token

#### Purpose and Scope

The Developer Token is a JWT (JSON Web Token) used to authenticate requests to Apple Music API catalog endpoints. This token provides access exclusively to public catalog data without requiring user interaction or personal data access.

**Data Accessible:**
- Catalog search and suggestions
- Songs, albums, artists, and playlists from the catalog
- Genres and curators information
- Radio shows and stations
- Music videos and record labels
- Charts and trending content
- Activities and editorial collections

#### Technical Requirements

The Developer Token requires the following credentials:
- **MusicKit Identifier**: A unique identifier assigned by Apple when enabling the MusicKit App Service in the Developer Portal
- **Private Key (P8 Format)**: A private key file downloaded from the Apple Developer Portal
- **Team ID**: The Apple development team identifier
- **Bundle ID**: The application bundle identifier (must match between Xcode and App ID registration)

#### Token Generation Method

The Developer Token is generated as a JWT with the following structure:
- **Header**: Contains algorithm (ES256) and the MusicKit identifier as the key ID
- **Payload**: Includes standard JWT claims such as issuer (Team ID), issued time, and expiration (typically 6 months)
- **Signature**: Signed using the ES256 algorithm with the private P8 key

#### Implementation Strategy for MCP Server

**The Developer Token should be generated and managed internally by the MCP server.** This approach is recommended because:

1. **Centralized Security**: The private key and credentials are stored securely on the server, not distributed to clients
2. **Automatic Token Management**: The server handles token lifecycle, including renewal before expiration
3. **Transparent Operation**: Client applications don't need to manage token generation
4. **Caching Efficiency**: Tokens are cached and reused throughout their validity period

**Server-Side Implementation Steps:**

1. Store the private key (P8 file), Team ID, and MusicKit Identifier securely within the server configuration
2. Implement JWT generation logic using the ES256 signing algorithm
3. Implement token caching to avoid regenerating tokens unnecessarily
4. Implement automatic token renewal when approaching expiration (recommended 30 days before expiration)
5. Validate token expiration before making API requests and regenerate if needed

**Token Delivery to Server:**

The Developer Token credentials should be provided to the MCP server through:
- Environment variables: `APPLE_MUSIC_PRIVATE_KEY`, `APPLE_MUSIC_TEAM_ID`, `APPLE_MUSIC_MUSICKIT_ID`
- Configuration file: A JSON file containing the required credentials with restricted file permissions (user read-only)
- Startup parameters: Command-line arguments passed during server initialization

### 2. User Token

#### Purpose and Scope

The User Token is an authorization token obtained after a user explicitly authorizes the application to access their Apple Music data. This token provides access to user-specific, personalized data that requires explicit user consent.

**Data Accessible:**
- User's personal library (playlists, saved songs, saved albums, saved artists)
- User's playback history and recently played content
- Personalized recommendations based on listening history
- User's annual Replay data
- User's favorite resources and ratings
- User's storefront and regional preferences

#### Authorization Flow Requirement

Unlike the Developer Token, obtaining a User Token requires explicit user authorization. The process involves:
- User seeing and interacting with Apple's native authorization dialog
- User explicitly granting permission for the application to access their music data
- Apple's authentication infrastructure managing the token lifecycle
- The User Token remaining valid for the duration of the user's authenticated session

#### Why Server-Side Generation Is Not Possible

The User Token cannot be generated by the MCP server because:
1. Apple's authorization process requires user interaction with Apple's official authentication interface
2. The token cannot be obtained without user consent through Apple's authorization flow
3. The server cannot impersonate or bypass Apple's authentication requirements
4. Privacy and security regulations require user-facing authorization dialogs to originate from authenticated sources

#### Implementation Strategy: CLI-Based User Acquisition

**The User Token must be obtained by a client application and delivered to the MCP server as input.** The recommended approach is to implement a command-line interface (CLI) tool that automates this process.

**CLI-Based Authentication Architecture:**

The CLI tool operates as follows:

1. **Local Server Initialization**: The CLI starts a temporary local HTTP server on a configurable port (typically 3000)
2. **Automatic Browser Launch**: The CLI automatically opens the user's default web browser, directing it to the local server
3. **Web-Based Authentication UI**: The browser displays a web page containing MusicKit for Web integration
4. **User Authorization**: The user clicks an authorization button, which triggers Apple's native authentication dialog
5. **Token Acquisition**: Upon user approval, MusicKit automatically obtains the User Token
6. **Token Transmission**: The User Token is transmitted from the browser back to the CLI via an HTTP callback
7. **Configuration Storage**: The CLI stores the User Token securely in the user's home directory with restricted file permissions
8. **Server Ready**: The MCP server reads the stored configuration and is now ready to make authenticated requests

**Technology Stack for CLI Implementation:**

- **Runtime**: Node.js (JavaScript/TypeScript)
- **Framework**: Express.js or similar for the temporary HTTP server
- **Browser Integration**: The `open` package to automatically launch the default browser
- **Client-Side Auth**: MusicKit for Web (JavaScript SDK) for handling the authorization flow
- **Configuration Storage**: JSON files stored in `~/.config/apple-music-mcp/` directory

**Execution Flow from User Perspective:**

1. User runs CLI command: `npx apple-music-mcp setup`
2. CLI validates that the Developer Token is available (via environment variable or configuration)
3. CLI starts a temporary local server
4. User's browser automatically opens to the local authentication page
5. User sees a button to "Connect with Apple Music"
6. User clicks the button and sees Apple's authentication dialog
7. User approves access to their music data
8. The browser automatically transmits the User Token to the CLI
9. CLI saves the configuration file with both Developer Token and User Token
10. CLI displays confirmation and exits
11. The MCP server can now be started and will use the stored tokens

**Configuration Storage:**

The CLI stores the User Token in a secure location:
- **Location**: User's home directory under `.config/apple-music-mcp/config.json`
- **Permissions**: Restricted to user-read-only (mode 0600 on Unix-like systems)
- **Contents**: Includes both the User Token and Developer Token for convenience
- **Metadata**: Includes timestamp of configuration and expected token validity periods

**Token Delivery Methods to MCP Server:**

The MCP server can access the User Token through multiple methods:

1. **Configuration File**: The server reads the stored configuration from the user's home directory
2. **Environment Variables**: The User Token can be loaded from environment variables like `APPLE_MUSIC_USER_TOKEN`
3. **Startup Parameters**: The token can be passed as a command-line argument to the server
4. **Dynamic API Endpoint**: The server can expose an HTTP endpoint to update the User Token without restarting

**Multi-Platform Compatibility:**

The CLI-based approach works across all major platforms:
- **macOS**: Native support for opening default browser
- **Linux**: Support for common desktop environments and browser auto-launching
- **Windows**: Native support for opening default browser
- **Language Agnostic**: Can be implemented in Node.js, Python, Go, or any language with HTTP server capabilities

## Comparison Matrix

| Aspect | Developer Token | User Token |
|--------|-----------------|-----------|
| **Generation Location** | MCP Server (internal) | Client Application (CLI tool) |
| **Required Credentials** | Private Key (P8), Team ID, MusicKit ID | None (obtained through OAuth) |
| **User Interaction Required** | No | Yes (approval dialog) |
| **Data Access** | Public catalog only | Personal library and history |
| **Token Validity** | ~6 months | Duration of user session |
| **Renewal Strategy** | Server-side automatic renewal | User re-authorizes if needed |
| **Security Storage** | Server-side secure storage | Client-side local configuration |
| **Implementation Complexity** | Medium (JWT generation) | Low (MusicKit handles complexity) |

## Recommended MCP Server Architecture

The MCP server should implement the following authentication architecture:

1. **Initialization Phase**:
   - Load Developer Token credentials from environment or configuration file
   - Generate initial Developer Token
   - Check for stored User Token in local configuration directory
   - If User Token missing, inform user to run CLI setup

2. **Authentication Module**:
   - Maintain Developer Token in memory with automatic expiration tracking
   - Load and validate User Token from stored configuration
   - Implement token validation middleware for all API requests
   - Provide methods to refresh or update tokens

3. **API Request Handling**:
   - For catalog endpoints: Automatically include Developer Token in Authorization header
   - For user library endpoints: Automatically include User Token in Authorization header
   - Handle token expiration errors and implement retry logic with token refresh

4. **Configuration Management**:
   - Provide clear error messages if tokens are missing or invalid
   - Support multiple configuration sources (environment, files, defaults)
   - Implement secure token storage with appropriate file permissions

## Setup Workflow for End Users

The complete setup workflow for end users involves these steps:

1. **Install MCP Server**: User installs the MCP server package (via npm, pip, or other package manager)

2. **Prepare Developer Token**: User obtains Developer Token credentials from Apple Developer Portal:
   - Enable MusicKit App Service
   - Download private key file
   - Note Team ID and MusicKit Identifier
   - Set as environment variable or configuration file

3. **Run CLI Setup**: User executes the CLI setup command, which:
   - Validates Developer Token is available
   - Starts temporary local server
   - Opens browser automatically
   - Guides user through Apple authorization
   - Stores configuration locally

4. **Start MCP Server**: User starts the MCP server, which:
   - Loads configuration from local storage
   - Generates and caches Developer Token
   - Loads User Token from configuration
   - Becomes ready to accept MCP calls

5. **Use MCP Server**: MCP clients can now:
   - Query public catalog using Developer Token
   - Access user library data using User Token
   - Benefit from automatic token management and renewal

## Security Considerations

1. **Developer Token Protection**: The private key must never be exposed publicly or committed to version control. Use environment variables or encrypted configuration files.

2. **User Token Storage**: The User Token should be stored with restricted file permissions (user-read-only) and never transmitted over unencrypted connections.

3. **CLI Tool Security**: The temporary HTTP server should only listen on localhost (127.0.0.1) to prevent remote exploitation. Use HTTPS for production deployments.

4. **Token Validation**: The server should validate tokens before using them and handle expiration gracefully.

5. **Configuration File Security**: Configuration files containing tokens should be protected with appropriate file system permissions and not included in backups or version control systems.

## Conclusion

The two-token authentication system provides a clear separation of concerns:

- **Developer Token**: Server-managed, regenerated automatically, handles all catalog access
- **User Token**: User-obtained through CLI, represents explicit user authorization, handles personal library access

This architecture allows the MCP server to be distributed without embedding user credentials while providing a seamless developer experience through automated CLI setup. The use of a CLI tool with browser auto-launching provides a frictionless authentication experience that follows modern OAuth patterns while remaining simple to implement and use.